<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "//ibatis.apache.org//DTD SQL Map 2.0//EN" 
"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="htg">
	
	<resultMap id="UsuarioCore" class="com.htg.mills.entities.Usuario">
		<result property="id" column="user_id"/>
		<result property="creationDate" column="creation_date"/>
		<result property="login" column="login"/>
		<result property="password" column="_password"/>
		<result property="name" column="nombre"/>
		<result property="email" column="email"/>
		<result property="type" column="tipo_user"/>
		<result property="modulesStr" column="user_modulos"/>
		<result property="status" column="user_estado"/>
		<result property="feActivacion" column="fe_activacion"/>
	</resultMap>

	<resultMap id="Usuario" class="com.htg.mills.entities.Usuario" extends="UsuarioCore">
	</resultMap>
	
	<resultMap id="Comment" class="com.htg.mills.entities.Comment">
		<result property="comment" column="comentario"/>
		<result property="date" column="fecha"/>
		<result property="autor" column="autor"/>	
	</resultMap>

	<resultMap id="TurnoCore" class="com.htg.mills.entities.maintenance.Turno">
		<result property="id" column="id"/>
		<result property="creationDate" column="fec_creacion"/>
		<result property="name" column="nombre"/>
		<result property="status" column="estado"/>
		<result property="turnoId" column="turno_id"/>
	</resultMap>

	<resultMap id="Turno" class="com.htg.mills.entities.maintenance.Turno" extends="TurnoCore">
		<result property="molino" column="molino_id" select="getMolinoById"/>
		<result property="history" column="id" select="getHistorialTurno"/>
		<result property="personas" column="id" select="getPersonasTurno"/>
	</resultMap>

	<resultMap id="Persona" class="com.htg.mills.entities.maintenance.Persona">
		<result property="name" column="nombre"/>
		<result property="rut" column="rut"/>
		<result property="role" column="cargo"/>
		<result property="controllerId" column="user_id_controller"/>
	</resultMap>

	<resultMap id="TurnoHistorial" class="com.htg.mills.entities.maintenance.TurnoHistorial">
		<result property="id" column="id"/>
		<result property="creationDate" column="fecha_inicio"/>
		<result property="closedDate" column="fecha_termino"/>
		<result property="turno" column="turno_id" select="getTurnoCoreById"/>
	</resultMap>
	
	<resultMap id="Molino" class="com.htg.mills.entities.maintenance.Molino">
		<result property="id" column="id"/>
		<result property="creationDate" column="fec_creacion"/>
		<result property="name" column="nombre"/>
		<result property="type" column="tipo"/>
		<result property="status" column="estado"/>
		<result property="statusAdmin" column="estado_admin"/>
		<result property="stage" column="etapa"/>
		<result property="turns" column="id" select="getTurnosByMolino"/>
		<result property="stages" column="id" select="getEtapasByMolino"/>
		<result property="parts" column="id" select="getPartesByMolino"/>
		<result property="faena" column="faena_id" select="getFaenaById"/>
	</resultMap>

	<resultMap id="Faena" class="com.htg.mills.entities.maintenance.Faena">
		<result property="id" column="id"/>
		<result property="creationDate" column="fec_creacion"/>
		<result property="name" column="nombre"/>
		<result property="client" column="cliente_id" select="getClienteById"/>
	</resultMap>
	
	<resultMap id="Cliente" class="com.htg.mills.entities.maintenance.Cliente">
		<result property="id" column="id"/>
		<result property="creationDate" column="fec_creacion"/>
		<result property="name" column="nombre"/>
	</resultMap>
	
	<resultMap id="Etapa" class="com.htg.mills.entities.maintenance.Etapa">
		<result property="id" column="id"/>
		<result property="creationDate" column="fecha_inicio"/>
		<result property="stage" column="etapa"/>
		<result property="finishDate" column="fecha_termino"/>
		<result property="status" column="estado"/>
		<result property="userStart" column="user_inicio"/>
		<result property="userFinish" column="user_termino"/>
		<result property="tasks" column="id" select="getTareasByEtapa"/>
		<result property="events" column="id" select="getEventosByEtapa"/>
		<result property="turnoStart" column="turno_id_inicio" select="getHistorialTurnoById"/>
		<result property="turnoFinish" column="turno_id_termino" select="getHistorialTurnoById"/>
	</resultMap>

	<resultMap id="Evento" class="com.htg.mills.entities.maintenance.Evento">
		<result property="id" column="id"/>
		<result property="creationDate" column="fecha_inicio"/>
		<result property="type" column="tipo"/>
		<result property="comments" column="comentarios"/>
		<result property="finishDate" column="fecha_termino"/>
		<result property="userStart" column="user_inicio"/>
		<result property="userFinish" column="user_termino"/>
	</resultMap>
	
	<resultMap id="Tarea" class="com.htg.mills.entities.maintenance.Tarea">
		<result property="id" column="id"/>
		<result property="creationDate" column="fecha_inicio"/>
		<result property="task" column="tarea"/>
		<result property="finishDate" column="fecha_termino"/>
		<result property="userStart" column="user_inicio"/>
		<result property="userFinish" column="user_termino"/>
		<result property="turnoStart" column="turno_id_inicio" select="getHistorialTurnoById"/>
		<result property="turnoFinish" column="turno_id_termino" select="getHistorialTurnoById"/>
		<result property="parts" column="id" select="getPartesByTarea"/>
	</resultMap>

	<resultMap id="Parte" class="com.htg.mills.entities.maintenance.Parte">
		<result property="id" column="id"/>
		<result property="creationDate" column="fec_creacion"/>
		<result property="name" column="nombre"/>
		<result property="type" column="tipo"/>
		<result property="qty" column="cantidad"/>
		<result property="botadas" column="botadas"/>
		<result property="limpiadas" column="limpiadas"/>
		<result property="montadas" column="montadas"/>
		<result property="totalBotadas" column="total_botadas"/>
		<result property="totalLimpiadas" column="total_limpiadas"/>
		<result property="totalMontadas" column="total_montadas"/>
	</resultMap>
	
	<resultMap id="TareaParte" class="com.htg.mills.entities.maintenance.TareaParte">
		<result property="id" column="id"/>
		<result property="creationDate" column="fecha"/>
		<result property="user" column="usuario"/>
		<result property="qty" column="cantidad"/>
		<result property="part" column="parte_id" select="getParteById"/>
		<result property="turno" column="turno_id" select="getHistorialTurnoById"/>
	</resultMap>

	<insert id="insertToken">
		insert into tokens(id, user_id, token, expiration, creation)
			values(#id#, #user.id#, #token#, #expiration#, #creation#)
	</insert>
	
	<delete id="deleteToken">
		delete from tokens
		where token = #value#
	</delete>

	<select id="selectToken" resultClass="com.htg.mills.entities.Token">
		select id, token, expiration, creation
		from tokens
		where token = #value#
	</select>
	
	<delete id="deleteOtherTokens">
		delete from tokens
		where user_id = #user.id#
			and token != #token#
	</delete>
	
	<select id="getUserById" resultMap="Usuario">
		select id user_id, creation_date, nombre, login, _password, email, tipo tipo_user, modulos user_modulos, estado user_estado, fe_activacion
		from users
		WHERE id = #value#
	</select>
	
	<select id="getTotalRows" resultClass="java.lang.Integer">
		SELECT FOUND_ROWS()
	</select>

	<select id="getParametros" resultClass="java.util.HashMap">
		select nombre, valor
		from parametros
	</select>
		
	<select id="getUserByLogin" resultMap="Usuario">
		select a.id user_id, a.creation_date, a.nombre, a.login, a._password, a.email, a.tipo tipo_user, a.modulos user_modulos, a.estado user_estado, a.fe_activacion
		FROM users a
		WHERE a.login = #login#
	</select>
	
	<update id="resetPassword">
		update users
			set _password = #password#
				, fe_activacion = null
		where id = #id#
	</update>
	
	<insert id="insertUser">
		insert into users(id, creation_date, nombre, tipo, email, login, _password, modulos, estado)
			values(#id#, #creationDate#, #name#, #type#, #email#, #login#, #password#, #modulesStr#, #status#)
	</insert>
	
	<update id="updateUser">
		update users
			set nombre = #name#,
				tipo = #type#,
				email = #email#,
				login = #login#,
				modulos = #modulesStr#,
				estado = #status#
				<isNotNull property="feActivacion">
				, fe_activacion = #feActivacion#
				</isNotNull>
				<isNotNull property="password">
				, _password = #password#
				</isNotNull>
		where id = #id#
	</update>

	<insert id="insertNotificationAWS">
		insert into aws_notifications(id, message_id, notification_type, json, form_id, _from, destination, _to, message, subject, timestamp)
			values(#id#, #messageId#, #type#, #json#, #formId#, #from#, #destination#, #to#, #message#, #subject#, #timestamp#)
	</insert>

	<delete id="deleteUser">
		delete from users
		where id = #value#
	</delete>

	<select id="getUsers" resultMap="UsuarioCore">
		select id user_id, creation_date, nombre, login, _password, email, tipo tipo_user, modulos user_modulos, estado user_estado, fe_activacion
		from users
		order by tipo, nombre
	</select>
	
	<select id="getPersonasTurno" resultMap="Persona">
		select nombre, rut, cargo, user_id_controller
		from turno_personas
		where turno_id = #value#
	</select>
	
	<select id="getHistorialTurno" resultMap="TurnoHistorial">
		select id, fecha_inicio, fecha_termino, turno_id
		from turno_historial
		where turno_id = #value#
		order by fecha_inicio
	</select>
	
	<select id="getHistorialTurnoById" resultMap="TurnoHistorial">
		select id, fecha_inicio, fecha_termino, turno_id
		from turno_historial
		where id = #value#
	</select>

	<select id="getTurnosActivosController" resultMap="Turno">
		select a.id, a.fec_creacion, a.nombre, a.estado, a.molino_id, a.turno_id
		from turnos a, turno_personas b, molinos c
		where b.turno_id = a.id
			and b.user_id_controller = #value#
			and c.id = a.molino_id
			and c.estado_admin = 'ACTIVE'
			and (ifnull(c.estado,'WAIT') != 'FINISHED' OR a.estado = 'OPEN')
	</select>
	
	<select id="getTurnosByMolino" resultMap="TurnoCore">
		select a.id, a.fec_creacion, a.nombre, a.estado, a.turno_id
		from turnos a
		where molino_id = #value#
	</select>
	
	<select id="getTurnoCoreById" resultMap="TurnoCore">
		select a.id, a.fec_creacion, a.nombre, a.estado, a.turno_id
		from turnos a
		where id = #value#
	</select>
	
	<select id="getTurnoById" resultMap="Turno">
		select a.id, a.fec_creacion, a.nombre, a.estado, a.molino_id, a.turno_id
		from turnos a
		where id = #value#
	</select>
	
	<select id="getMolinoById" resultMap="Molino">
		select id, fec_creacion, nombre, tipo, estado, estado_admin, etapa, faena_id
		from molinos
		where id = #value#
	</select>
	
	<select id="getEtapasByMolino" resultMap="Etapa">
		select id, fecha_inicio, etapa, estado, fecha_termino, user_inicio, user_termino, turno_id_inicio, turno_id_termino
		from molino_etapas
		where molino_id = #value#
		order by fecha_inicio
	</select>
	
	<select id="getEventosByEtapa" resultMap="Evento">
		select id, fecha_inicio, tipo, comentarios, fecha_termino, user_inicio, user_termino
		from etapa_eventos
		where etapa_id = #value#
		order by fecha_inicio
	</select>
	
	<select id="getTareasByEtapa" resultMap="Tarea">
		select id, fecha_inicio, tarea, fecha_termino, user_inicio, user_termino, turno_id_inicio, turno_id_termino
		from etapa_tareas
		where etapa_id = #value#
		order by fecha_inicio
	</select>

	<select id="getPartesByMolino" resultMap="Parte">
		select id, fec_creacion, nombre, tipo, cantidad, botadas, limpiadas, montadas, total_botadas, total_limpiadas, total_montadas
		from molino_partes
		where molino_id = #value#
	</select>
	
	<select id="getParteById" resultMap="Parte">
		select id, fec_creacion, nombre, tipo, cantidad, botadas, limpiadas, montadas, total_botadas, total_limpiadas, total_montadas
		from molino_partes
		where id = #value#
	</select>

	<select id="getPartesByTarea" resultMap="TareaParte">
		select id, fecha, usuario, cantidad, parte_id, turno_id
		from tarea_partes
		where tarea_id = #value#
		order by fecha
	</select>
	
	<select id="getFaenaById" resultMap="Faena">
		select id, fec_creacion, nombre, cliente_id
		from faenas
		where id = #value#
	</select>
	
	<select id="getClienteById" resultMap="Cliente">
		select id, fec_creacion, nombre
		from clientes
		where id = #value#	
	</select>
	
	<update id="updateStatusTurno">
		update turnos
			set estado = #status#,
				turno_id = #turnoId#
		where id=#id#
	</update>
	
	<insert id="insertTurnoHistorial">
		insert into turno_historial(id, turno_id, fecha_inicio)
		values(#id#, #turno.id#, #fecha#)
	</insert>
	
	<update id="updateStatusMolino">
		update molinos
			set estado = #status#,
				etapa = #stage#
		where id = #id#
	</update>
	
	<update id="finTurnoHistorial">
		update turno_historial
			set fecha_termino = #fecha#
		where id = #turnoId#
	</update>
	
	<insert id="insertEtapa">
		insert into molino_etapas(id, etapa, estado, fecha_inicio, user_inicio, molino_id, turno_id_inicio)
			values(#etapa.id#, #etapa.stage#, #etapa.status#, #etapa.creationDate#, #etapa.userStart#, #molino.id#, #turnoId#)
	</insert>
	
	<insert id="insertTarea">
		insert into etapa_tareas(id, tarea, fecha_inicio, user_inicio, etapa_id, turno_id_inicio)
			values(#tarea.id#, #tarea.task#, #tarea.creationDate#, #tarea.userStart#, #etapa.id#, #turnoId#)
	</insert>
	
	<update id="finishTarea">
		update etapa_tareas
			set fecha_termino = #finishDate#,
				user_termino = #userFinish#,
				turno_id_termino = #turnoFinish.id#
		where id = #id#
	</update>
	
	<update id="finishEtapa">
		update molino_etapas
			set fecha_termino = #finishDate#,
				user_termino = #userFinish#,
				estado = #status#,
				turno_id_termino = #turnoFinish.id#
		where id = #id#
	</update>
	
	<update id="updatePartes">
		update molino_partes
			set botadas = #botadas#,
				total_botadas = #totalBotadas#,
				limpiadas = #limpiadas#,
				total_limpiadas = #totalLimpiadas#,
				montadas = #montadas#,
				total_montadas = #totalMontadas#
		where id = #id#
	</update>
	
	<insert id="insertTareaParte">
		insert into tarea_partes(id, fecha, usuario, cantidad, tarea_id, parte_id, turno_id)
			values(#id#, #creationDate#, #user#, #qty#, #tareaId#, #part.id#, #turno.id#)
	</insert>
	
	<update id="updateGiro">
		update molino_partes
			set botadas = 0,
				limpiadas = 0,
				montadas = 0
		where molino_id = #value#
	</update>

</sqlMap>
